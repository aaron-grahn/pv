#include <memory>
#include <iostream>
#include <string>
#include <cassert>
#include "io.h"
#include "in_base.h"
#include "in_ascii.h"

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
Io::Istream::Base::Base(std::istream &is)
   : m_is(is)
{
}

////////////////////////////////////////////////////////////////////////////////
Buffer Io::Istream::Base::read()
{
   std::string data;
   m_is >> data;
   return decode(data);
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
namespace
{
   // If you've ever read "The Ones who Walk Away from Omelas," you'll
   // understand this code.
   std::unique_ptr<Io::Istream::Base> in(nullptr); 

   /////////////////////////////////////////////////////////////////////////////
   Io::Istream::Base &get_stream(std::istream &is, Io::Encoding enc)
   {
      if(enc == Io::Encoding::Ascii)
      {
         in.reset(new Io::Istream::Ascii(is));
      }
      else
      {
         assert(false);
      }
      return *in;
   }
} // namespace

////////////////////////////////////////////////////////////////////////////////
Io::Istream::Base &operator>>(std::istream &is, Io::Encoding enc)
{
   return get_stream(is, enc);
}

